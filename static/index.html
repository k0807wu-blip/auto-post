<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Facebook 自動發文排程</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; max-width: 720px; margin: 0 auto; padding: 1.5rem; }
    h1 { font-size: 1.25rem; margin-bottom: 1rem; }
    label { display: block; margin-top: 0.75rem; font-weight: 500; }
    input, textarea { width: 100%; padding: 0.5rem; margin-top: 0.25rem; }
    textarea { min-height: 80px; resize: vertical; }
    button { margin-top: 1rem; padding: 0.5rem 1rem; cursor: pointer; }
    .filters { margin: 1rem 0; }
    .filters button { margin-right: 0.5rem; margin-top: 0; }
    .filters button.active { background: #333; color: #fff; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { text-align: left; padding: 0.5rem; border-bottom: 1px solid #eee; }
    .status-pending { color: #b8860b; }
    .status-sent { color: #228b22; }
    .status-failed { color: #c00; }
    .msg { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .error { color: #c00; margin-top: 0.5rem; }
    .ai-section { background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin-top: 1.5rem; }
    .ai-section h2 { margin-top: 0; }
    .ai-preview { background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 1rem; margin-top: 0.75rem; white-space: pre-wrap; min-height: 60px; max-height: 400px; overflow-y: auto; }
    .ai-actions { margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .ai-actions button { margin-top: 0; }
    .btn-primary { background: #0d6efd; color: #fff; border: none; border-radius: 4px; }
    .btn-secondary { background: #6c757d; color: #fff; border: none; border-radius: 4px; }
    .btn-success { background: #198754; color: #fff; border: none; border-radius: 4px; }
    .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 0.6s linear infinite; vertical-align: middle; margin-right: 6px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .token-section { background: #fff8e1; border: 1px solid #ffe082; border-radius: 8px; padding: 1rem; margin-top: 1.5rem; }
    .token-section h2 { margin-top: 0; }
    .token-status { padding: 0.75rem; border-radius: 4px; margin-top: 0.5rem; font-size: 0.9rem; }
    .token-valid { background: #e8f5e9; border: 1px solid #a5d6a7; }
    .token-invalid { background: #ffebee; border: 1px solid #ef9a9a; }
    .token-unknown { background: #f5f5f5; border: 1px solid #e0e0e0; }
    .token-renew { margin-top: 0.75rem; }
    .token-renew input { margin-top: 0.25rem; }
    .success { color: #198754; margin-top: 0.5rem; }
  </style>
</head>
<body>
  <h1>Facebook 自動發文排程</h1>

  <section>
    <h2>新增排程</h2>
    <form id="form">
      <label>貼文內容 <span class="error" id="msgErr"></span></label>
      <textarea id="message" name="message" required></textarea>
      <label>排程時間</label>
      <input type="datetime-local" id="scheduled_time" name="scheduled_time" required />
      <label>附加連結（選填）</label>
      <input type="url" id="link" name="link" placeholder="https://" />
      <button type="submit">新增排程</button>
    </form>
  </section>

  <section class="ai-section">
    <h2>AI 自動產文</h2>
    <label>輸入主題 / 方向描述</label>
    <input type="text" id="ai_topic" placeholder="例：SBIR 計畫申請攻略、個人品牌經營心得" />
    <button type="button" id="ai_gen_btn" class="btn-primary" onclick="generateArticle()">生成文章</button>
    <div id="ai_preview" class="ai-preview" style="display:none;"></div>
    <div id="ai_actions" class="ai-actions" style="display:none;">
      <button type="button" class="btn-success" onclick="useArticle()">填入排程表單</button>
      <button type="button" class="btn-secondary" onclick="regenerate()">重新生成</button>
    </div>
    <div class="error" id="ai_err"></div>
  </section>

  <section>
    <h2>排程列表</h2>
    <div class="filters">
      <button type="button" data-filter="">全部</button>
      <button type="button" data-filter="pending">待發送</button>
      <button type="button" data-filter="sent">已發送</button>
      <button type="button" data-filter="failed">失敗</button>
    </div>
    <table>
      <thead>
        <tr><th>ID</th><th>狀態</th><th>排程時間</th><th>貼文內容</th><th>操作</th></tr>
      </thead>
      <tbody id="list"></tbody>
    </table>
  </section>

  <section class="token-section">
    <h2>Token 管理</h2>
    <div id="token_status" class="token-status token-unknown">載入中...</div>
    <div class="token-renew">
      <label>更新 Token（貼上從 <a href="https://developers.facebook.com/tools/explorer/?method=GET&path=me%2Faccounts&version=v24.0" target="_blank">Graph API Explorer</a> 取得的短期 Token）</label>
      <input type="text" id="token_input" placeholder="貼上短期 User Token 或 Page Token" />
      <button type="button" id="token_renew_btn" class="btn-primary" onclick="renewToken()">更新 Token</button>
      <div class="error" id="token_err"></div>
      <div class="success" id="token_ok"></div>
    </div>
  </section>

  <script>
    const form = document.getElementById('form');
    const listEl = document.getElementById('list');
    const msgErr = document.getElementById('msgErr');
    let currentFilter = '';

    function setFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filters button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
      });
      loadPosts();
    }

    async function loadPosts() {
      const url = currentFilter ? `/api/posts?status=${currentFilter}` : '/api/posts';
      const res = await fetch(url);
      if (!res.ok) return;
      const posts = await res.json();
      listEl.innerHTML = posts.map(p => {
        const time = (p.scheduled_time || '').replace('T', ' ').slice(0, 16);
        const statusClass = 'status-' + (p.status || '');
        const statusText = { pending: '待發送', sent: '已發送', failed: '失敗' }[p.status] || p.status;
        const msg = (p.message || '').length > 40 ? p.message.slice(0, 40) + '…' : p.message;
        const delBtn = p.status === 'pending'
          ? `<button type="button" data-id="${p.id}" class="btn-del">刪除</button>`
          : '';
        return `<tr>
          <td>${p.id}</td>
          <td class="${statusClass}">${statusText}</td>
          <td>${time}</td>
          <td class="msg" title="${(p.message || '').replace(/"/g, '&quot;')}">${escapeHtml(msg)}</td>
          <td>${delBtn}</td>
        </tr>`;
      }).join('');

      listEl.querySelectorAll('.btn-del').forEach(btn => {
        btn.addEventListener('click', () => removePost(btn.dataset.id));
      });
    }

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    async function removePost(id) {
      if (!confirm('確定要移除這則排程？')) return;
      const res = await fetch(`/api/posts/${id}`, { method: 'DELETE' });
      if (res.ok) loadPosts();
      else {
        const err = await res.json();
        alert(err.detail || '刪除失敗');
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msgErr.textContent = '';
      const message = document.getElementById('message').value.trim();
      const scheduled_time = document.getElementById('scheduled_time').value;
      const link = document.getElementById('link').value.trim() || null;
      if (!message) {
        msgErr.textContent = '請輸入貼文內容';
        return;
      }
      try {
        const res = await fetch('/api/posts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, scheduled_time, link })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || '新增失敗');
        form.reset();
        loadPosts();
      } catch (err) {
        msgErr.textContent = err.message;
      }
    });

    document.querySelectorAll('.filters button').forEach(btn => {
      btn.addEventListener('click', () => setFilter(btn.dataset.filter));
    });

    setFilter('');

    /* ── AI 產文 ── */
    let lastArticle = '';

    async function generateArticle() {
      const topic = document.getElementById('ai_topic').value.trim();
      const errEl = document.getElementById('ai_err');
      const previewEl = document.getElementById('ai_preview');
      const actionsEl = document.getElementById('ai_actions');
      const btn = document.getElementById('ai_gen_btn');
      errEl.textContent = '';
      if (!topic) { errEl.textContent = '請輸入主題'; return; }

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>生成中...';
      previewEl.style.display = 'none';
      actionsEl.style.display = 'none';

      try {
        const res = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ topic })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || '生成失敗');
        lastArticle = data.article;
        previewEl.textContent = lastArticle;
        previewEl.style.display = 'block';
        actionsEl.style.display = 'flex';
      } catch (e) {
        errEl.textContent = e.message;
      } finally {
        btn.disabled = false;
        btn.textContent = '生成文章';
      }
    }

    function useArticle() {
      if (!lastArticle) return;
      document.getElementById('message').value = lastArticle;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function regenerate() {
      generateArticle();
    }

    /* ── Token 管理 ── */
    async function loadTokenStatus() {
      const el = document.getElementById('token_status');
      try {
        const res = await fetch('/api/token/status');
        const data = await res.json();
        if (data.error) {
          el.className = 'token-status token-unknown';
          el.textContent = data.error;
          return;
        }
        if (!data.has_token) {
          el.className = 'token-status token-invalid';
          el.textContent = '尚未設定 Token，請在下方貼上短期 Token 來更新。';
          return;
        }
        if (data.is_valid) {
          const expires = data.expires_at === 0 ? '永不過期' : new Date(data.expires_at * 1000).toLocaleString('zh-TW');
          const src = data.source === 'database' ? '資料庫（永久 Token）' : '環境變數';
          el.className = 'token-status token-valid';
          el.innerHTML = `Token 有效 &nbsp;|&nbsp; 來源：${src} &nbsp;|&nbsp; 到期：${expires} &nbsp;|&nbsp; 類型：${data.type || '-'}`;
        } else {
          el.className = 'token-status token-invalid';
          el.textContent = 'Token 已失效，請在下方更新。';
        }
      } catch (e) {
        el.className = 'token-status token-unknown';
        el.textContent = '無法載入 Token 狀態';
      }
    }

    async function renewToken() {
      const input = document.getElementById('token_input');
      const errEl = document.getElementById('token_err');
      const okEl = document.getElementById('token_ok');
      const btn = document.getElementById('token_renew_btn');
      errEl.textContent = '';
      okEl.textContent = '';
      const short_token = input.value.trim();
      if (!short_token) { errEl.textContent = '請貼上 Token'; return; }

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>更新中...';
      try {
        const res = await fetch('/api/token/renew', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ short_token })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || '更新失敗');
        okEl.textContent = '永久 Page Token 更新成功！';
        input.value = '';
        loadTokenStatus();
      } catch (e) {
        errEl.textContent = e.message;
      } finally {
        btn.disabled = false;
        btn.textContent = '更新 Token';
      }
    }

    loadTokenStatus();
  </script>
</body>
</html>
